sda = 1
scl = 2
TIMEZONE = 8
City=""
Weather=""
Temperature=""
suer=""


local cloudy_width = 40              --天气图形取模
local cloudy_height = 40                --多云
local cloudy_bits = string.char(
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x02, 0x00, 0x00, 0x00,
0x00, 0x02, 0x00, 0x00, 0x00, 0x00, 0x04, 0x81, 0x01, 0x00, 0x00, 0x04,
0x81, 0x00, 0x00, 0x00, 0x0C, 0x41, 0x00, 0x00, 0x00, 0x08, 0x60, 0x00,
0x00, 0x00, 0xF8, 0x2F, 0x00, 0x00, 0x00, 0x0C, 0x18, 0x00, 0x00, 0x7E,
0x06, 0x20, 0x00, 0x80, 0xC1, 0x13, 0x40, 0x0E, 0xC0, 0x00, 0xFF, 0xC0,
0x02, 0x60, 0x00, 0x82, 0x81, 0x00, 0x20, 0x00, 0x00, 0x83, 0x00, 0x30,
0x00, 0x00, 0x82, 0x01, 0x10, 0x00, 0x00, 0x8E, 0x01, 0x18, 0x00, 0x00,
0x90, 0x7F, 0x0C, 0x00, 0x00, 0xB0, 0x00, 0x04, 0x00, 0x00, 0xA0, 0x00,
0x02, 0x00, 0x00, 0xE0, 0x00, 0x02, 0x00, 0x00, 0xC0, 0x00, 0x02, 0x00,
0x00, 0x80, 0x00, 0x02, 0x00, 0x00, 0x80, 0x00, 0x02, 0x00, 0x00, 0x80,
0x00, 0x04, 0x00, 0x00, 0x80, 0x00, 0x0C, 0x00, 0x00, 0xC0, 0x00, 0x18,
0x00, 0x00, 0x60, 0x00, 0xE0, 0xFF, 0xFF, 0x3F, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
)

local sunny_width = 40
local sunny_height = 40   --晴天
local sunny_bits = string.char(
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00,
0x00, 0x18, 0x00, 0x00, 0x00, 0x20, 0x18, 0x04, 0x00, 0x00, 0x60, 0x18,
0x06, 0x00, 0x00, 0x40, 0x00, 0x02, 0x00, 0x00, 0x00, 0x7E, 0x00, 0x00,
0x80, 0x80, 0x81, 0x81, 0x01, 0x00, 0x43, 0x00, 0xC2, 0x00, 0x00, 0x2C,
0x00, 0x34, 0x00, 0x00, 0x10, 0x00, 0x0C, 0x00, 0x00, 0x10, 0x00, 0x08,
0x00, 0x00, 0x18, 0x00, 0x18, 0x00, 0x00, 0x08, 0x00, 0x10, 0x00, 0x80,
0x0B, 0x00, 0xD0, 0x01, 0x00, 0x08, 0x00, 0x10, 0x00, 0x00, 0x08, 0x00,
0x10, 0x00, 0x00, 0x18, 0x00, 0x18, 0x00, 0x00, 0x10, 0x00, 0x08, 0x00,
0x00, 0x38, 0x00, 0x1C, 0x00, 0x00, 0x66, 0x00, 0x66, 0x00, 0x80, 0xC3,
0x00, 0xC3, 0x01, 0x80, 0x80, 0xE7, 0x01, 0x01, 0x00, 0x40, 0x3C, 0x02,
0x00, 0x00, 0x40, 0x00, 0x02, 0x00, 0x00, 0x20, 0x18, 0x06, 0x00, 0x00,
0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x18,
0x00, 0x00, 0x00, 0x00, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
)

local rain_width = 40
local rain_height = 40    --雨天
local rain_bits = string.char(
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x01, 0x00, 0x00, 0x00,
0x1C, 0x07, 0x00, 0x00, 0x00, 0x06, 0xEC, 0x03, 0x00, 0x00, 0x03, 0x18,
0x04, 0x00, 0x00, 0x01, 0x00, 0x08, 0x00, 0x80, 0x00, 0x00, 0x08, 0x00,
0x80, 0x00, 0x00, 0x38, 0x00, 0xC0, 0x00, 0x00, 0xC0, 0x00, 0x60, 0x00,
0x00, 0x80, 0x00, 0x30, 0x00, 0x00, 0x80, 0x00, 0x10, 0x00, 0x00, 0x80,
0x01, 0x10, 0x00, 0x00, 0x00, 0x02, 0x10, 0x00, 0x00, 0x00, 0x06, 0x10,
0x00, 0x00, 0x00, 0x04, 0x10, 0x00, 0x00, 0x00, 0x04, 0x10, 0x00, 0x00,
0x00, 0x04, 0x20, 0x00, 0x00, 0x00, 0x06, 0xC0, 0x00, 0x00, 0x00, 0x03,
0x80, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18,
0x08, 0x0C, 0x00, 0x00, 0x38, 0x1C, 0x1C, 0x00, 0x00, 0x28, 0x2C, 0x14,
0x00, 0x00, 0x48, 0x28, 0x24, 0x00, 0x00, 0x78, 0x38, 0x3C, 0x00, 0x00,
0x00, 0x83, 0x01, 0x00, 0x00, 0x00, 0x87, 0x03, 0x00, 0x00, 0x00, 0x85,
0x06, 0x00, 0x00, 0x00, 0x8D, 0x05, 0x00, 0x00, 0x00, 0x07, 0x07, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
)

local snow_width = 40
local snow_height = 40    --下雪
local snow_bits = string.char(
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xF0, 0x03, 0x00, 0x00, 0x00,
0x0C, 0x8C, 0x01, 0x00, 0x00, 0x06, 0xF8, 0x07, 0x00, 0x00, 0x02, 0x10,
0x08, 0x00, 0x00, 0x01, 0x00, 0x10, 0x00, 0x00, 0x01, 0x00, 0x10, 0x00,
0x00, 0x01, 0x00, 0xF0, 0x00, 0xC0, 0x01, 0x00, 0x80, 0x01, 0x40, 0x00,
0x00, 0x00, 0x01, 0x20, 0x00, 0x00, 0x00, 0x01, 0x30, 0x00, 0x00, 0x00,
0x03, 0x10, 0x00, 0x00, 0x00, 0x04, 0x10, 0x00, 0x00, 0x00, 0x0C, 0x10,
0x00, 0x00, 0x00, 0x08, 0x30, 0x00, 0x00, 0x00, 0x08, 0x20, 0x00, 0x00,
0x00, 0x0C, 0x40, 0x00, 0x00, 0x00, 0x04, 0x80, 0x01, 0x00, 0x00, 0x03,
0x00, 0xFF, 0xFF, 0xFF, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x04,
0x00, 0x20, 0x00, 0x00, 0x0F, 0x08, 0xF0, 0x00, 0x00, 0x1F, 0x6E, 0xF8,
0x00, 0x00, 0x0F, 0x3C, 0x70, 0x00, 0x00, 0x0F, 0x7F, 0xF0, 0x00, 0x00,
0x04, 0x3C, 0x20, 0x00, 0x00, 0x00, 0x6E, 0x00, 0x00, 0x00, 0x00, 0x08,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
)

local over_width = 40
local over_height = 40   --阴天
local over_bits = string.char(
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xC0,
0x0F, 0x00, 0x00, 0x00, 0x70, 0x18, 0x00, 0x00, 0xE0, 0x1F, 0x60, 0x00,
0x00, 0xF0, 0xFF, 0x7F, 0x00, 0x00, 0x18, 0x00, 0xC0, 0x00, 0x00, 0x08,
0x00, 0x80, 0x00, 0x00, 0xFE, 0xFF, 0xFF, 0x00, 0x80, 0x01, 0x00, 0x80,
0x01, 0x80, 0x00, 0x00, 0x00, 0x02, 0x80, 0xFF, 0xFF, 0xFF, 0x07, 0xC0,
0x00, 0x00, 0x00, 0x04, 0x20, 0x00, 0x00, 0x00, 0x0C, 0xF0, 0xFF, 0xFF,
0xFF, 0x0F, 0x10, 0x00, 0x00, 0x00, 0x0C, 0x10, 0x00, 0x00, 0x00, 0x04,
0xF0, 0xFF, 0xFF, 0xFF, 0x07, 0x20, 0x00, 0x00, 0x00, 0x02, 0x60, 0x00,
0x00, 0x80, 0x01, 0x80, 0xFF, 0xFF, 0xFF, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
)

local ziti_width = 16
local ziti_height = 16    --晴
local qing_bits = string.char(
0x00,0x04,0x00,0x04,0xDE,0x7F,0x12,0x04,0x92,0x3F,0x12,0x04,0xD2,0x7F,0x1E,0x00,
0x92,0x3F,0x92,0x20,0x92,0x3F,0x92,0x20,0x9E,0x3F,0x92,0x20,0x80,0x28,0x80,0x10

)


               --阴天
local yin_bits = string.char(
0x00,0x00,0xBE,0x3F,0xA2,0x20,0x92,0x20,0x92,0x20,0x8A,0x3F,0x92,0x20,0x92,0x20,
0xA2,0x20,0xA2,0x3F,0xA2,0x20,0x96,0x20,0x4A,0x20,0x42,0x20,0x22,0x28,0x12,0x10

)

                           --多云
local yun_bits = string.char(
0x00,0x00,0xFC,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x7F,0x40,0x00,
0x20,0x00,0x20,0x00,0x10,0x02,0x08,0x04,0x04,0x08,0xFE,0x1F,0x04,0x10,0x00,0x10

)

                            --雨天
local yu_bits = string.char(
0x00,0x00,0xFF,0x7F,0x80,0x00,0x80,0x00,0x80,0x00,0xFE,0x3F,0x82,0x20,0x82,0x20,
0x92,0x22,0xA2,0x24,0x82,0x20,0x92,0x22,0xA2,0x24,0x82,0x20,0x82,0x28,0x02,0x10

)

                        --雪
local xue_bits = string.char(
0x44,0x10,0x88,0x10,0x88,0x08,0x00,0x04,0xFE,0x7F,0x02,0x40,0x01,0x20,0xF8,0x07,
0x00,0x02,0x80,0x01,0xFF,0x7F,0x80,0x00,0x80,0x00,0x80,0x00,0xA0,0x00,0x40,0x00

)
                            --周
local zhou_bits = string.char(
0x00,0x00,0xFC,0x1F,0x84,0x10,0x84,0x10,0xF4,0x17,0x84,0x10,0x84,0x10,0xFC,0x1F,
0x04,0x10,0xE4,0x13,0x24,0x12,0x24,0x12,0xE4,0x13,0x02,0x10,0x02,0x14,0x01,0x08

)


                                --一
local yi_bits = string.char(
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x7F,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00

)

                            --二
local er_bits = string.char(
0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0x1F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x7F,0x00,0x00,0x00,0x00,0x00,0x00

)

                              -- 三

local san_bits = string.char(
0x00,0x00,0x00,0x00,0xFE,0x3F,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0x1F,
0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF,0x7F,0x00,0x00,0x00,0x00


)

                              --四

local si_bits = string.char(
0x00,0x00,0x00,0x00,0xFE,0x3F,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,0x22,
0x12,0x22,0x12,0x3C,0x0A,0x20,0x06,0x20,0x02,0x20,0xFE,0x3F,0x02,0x20,0x00,0x00


)

                              --五

local wu_bits = string.char(
0x00,0x00,0xFE,0x3F,0x40,0x00,0x40,0x00,0x40,0x00,0x40,0x00,0xFC,0x0F,0x20,0x08,
0x20,0x08,0x20,0x08,0x20,0x08,0x10,0x08,0x10,0x08,0x10,0x08,0xFF,0x7F,0x00,0x00

)

                              --六

local liu_bits = string.char(
0x40,0x00,0x80,0x00,0x00,0x01,0x00,0x01,0x00,0x00,0xFF,0x7F,0x00,0x00,0x00,0x00,
0x20,0x02,0x20,0x04,0x10,0x08,0x10,0x10,0x08,0x10,0x04,0x20,0x02,0x20,0x00,0x00
)


                             --日

local ri_bits = string.char(
0x00,0x00,0xF8,0x0F,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0xF8,0x0F,
0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0x08,0xF8,0x0F,0x08,0x08

)


function init_OLED(sda,scl)
     sla = 0x3c
     i2c.setup(0, sda, scl, i2c.SLOW)
     disp=u8g.ssd1306_128x64_i2c(sla)
     disp:setFont(u8g.font_fub14r)
     disp:setFontPosTop()
end

function print_OLED()
   disp:firstPage()
   repeat
        if Weather == "" and suer=="" then
            disp:setColorIndex(1)
            disp:setFont(u8g.font_fub11r)
            disp:drawStr(0,30,"weather station")
            disp:drawStr(15,50,"connecting...")
       else
     
       disp:setColorIndex(1)
       disp:setFont(u8g.font_fub20r)
       unixTime = rtctime.get()
       tm=rtctime.epoch2cal(unixTime + TIMEZONE*3600)

       disp:drawStr(6, 20, string.format("%02d", tm["hour"]))
       disp:drawStr(37, 19,":")
       disp:drawStr(50, 20, string.format("%02d", tm["min"]))
       disp:drawStr(81, 19,":")
       disp:drawStr(94, 20, string.format("%02d",  tm["sec"]))
       disp:setFont(u8g.font_fub11r)

       disp:drawStr(39, 41, string.format("%02d.%02d.%02d", tm["year"], tm["mon"], tm["day"]))


        disp:drawXBM(92,47, ziti_width,ziti_height, zhou_bits)
        if tm["wday"] == 2  then
        disp:drawXBM(107,47, ziti_width,ziti_height, yi_bits)
        elseif    tm["wday"] == 3 then
        disp:drawXBM(107,47, ziti_width,ziti_height, er_bits)
        elseif    tm["wday"] == 4 then
        disp:drawXBM(107,47, ziti_width,ziti_height, san_bits)
        elseif    tm["wday"] == 5 then
        disp:drawXBM(107,47, ziti_width,ziti_height, si_bits)
        elseif    tm["wday"] == 6 then
        disp:drawXBM(107,47, ziti_width,ziti_height, wu_bits)
        elseif    tm["wday"] == 7 then
        disp:drawXBM(107,47, ziti_width,ziti_height, liu_bits)
        else 
        disp:drawXBM(107,47, ziti_width,ziti_height, ri_bits)

        end


       
       if string.find(Weather,"Cloudy") ~= nil then
       disp:drawXBM(0,22, cloudy_width, cloudy_height, cloudy_bits)
       disp:drawXBM(75,47, ziti_width,ziti_height, yun_bits)
       elseif string.find(Weather,"Rain") ~= nil then
       disp:drawXBM(0,22, rain_width, rain_height, rain_bits) 
       disp:drawXBM(75,47, ziti_width, ziti_height, yu_bits)  
       elseif string.find(Weather,"Snow") ~= nil then
       disp:drawXBM(0,22, snow_width, snow_height, snow_bits)
       disp:drawXBM(75,47, ziti_width, ziti_height, xue_bits)
       elseif string.find(Weather,"Overcast") ~= nil then
       disp:drawXBM(0,22, over_width, over_height, over_bits)
       disp:drawXBM(75,47, ziti_width, ziti_height, yin_bits)
       elseif string.find(Weather,"Sunny") ~= nil then
       disp:drawXBM(0,22, sunny_width, sunny_height, sunny_bits)
       disp:drawXBM(75,47, ziti_width, ziti_height, qing_bits)
       elseif string.find(Weather,"Clear") ~= nil then
       disp:drawXBM(0,22, sunny_width, sunny_height, sunny_bits)
       disp:drawXBM(75,47, ziti_width, ziti_height, qing_bits)
       end
       disp:drawStr(36,61, Temperature.."'C")

       end
   until disp:nextPage() == false
end

init_OLED(sda,scl)
tmr.alarm(2, 1000, 1, function()
    print_OLED()
end)
